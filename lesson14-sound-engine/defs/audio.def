.scope AUDIO
  CHANNEL_SQ1    = %00000001
  CHANNEL_SQ2    = %00000010
  CHANNEL_TRI    = %00000100
  CHANNEL_NOISE  = %00001000

  CHANNEL_SQ1_INDEX = $00
  CHANNEL_SQ2_INDEX = $01
  CHANNEL_TRI_INDEX = $02
  CHANNEL_NOISE_INDEX = $03

  INSTRUMENT_SILENCE = $FF
  NOTE_HI_CACHE_BUST = $FF

  APU_REGISTER_LIST = $4000

  SPEED_MASK = %00000111

  .scope OP_CODES
    SILENCE = $60
    STOP = $61
    LENGTH = $62
    LOOP = $63
  .endscope

  .struct Registers
    env     .byte
    sweep   .byte
    note_lo .byte
    note_hi .byte
  .endstruct

  ;; A Track is an assignment of APU channels
  ;; to an encoded audio stream.
  .struct Track
    channels_active .byte ;; channel mask
    audio_header    .addr ;; -> Stream
    decoders        .addr ;; -> Decoder addr list
  .endstruct

  .struct Stream
    channels .byte ;; lower nybble = mask of channels used
    spempo   .byte ;; Speed | Tempo
    ;; Instruments?
    ;; Patterns?
    ;; Frames?
    ;; Etc

    ch0      .addr ;; -> [encoded audio stream bytes...]
    ch1      .addr ;; -> [encoded audio stream bytes...]
    ch2      .addr ;; -> [encoded audio stream bytes...]
    ch3      .addr ;; -> [encoded audio stream bytes...]
  .endstruct

  ;; A decoder is an audio stream with current progress and a decoding fsm
  .struct Decoder
    stream_head  .addr    ;; -> audio start
    registers    .tag Registers
    spempo       .byte ;; tttt-tsss , 3 bits of speed and 5 bits of tempo
                       ;; Speed is 0-7, equal to (# of ticks per tock) - 1
                       ;; Leave tempo for now but in theory we could adjust music
                       ;; dynamically by extending notes (aka
                       ;; increase the length of the current note by another tock)
                       ;; when the note length would cross a new tempo beat boundary.
    tick_counter .byte ;; Filled to Speed and decremented every tick. Produces a quarter of a beat on rollover.
    length       .byte ;; Indicates total note length
    elapsed      .byte ;; Indicates current note playtime
    remaining    .byte ;; Length-elapsed, indicates note left to play
    instrument    .byte ;; Index into instrument table

    ; length counter? ;;
    ;; loop counter?
    ;; channel done?
    ;; etc
  .endstruct
.endscope
